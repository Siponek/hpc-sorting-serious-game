<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0">
        <title>hpc-sorting-serious-game</title>
        <style>
            html,
            body,
            #canvas {
                margin: 0;
                padding: 0;
                border: 0;
            }

            body {
                color: white;
                background-color: black;
                overflow: hidden;
                touch-action: none;
            }

            #canvas {
                display: block;
            }

            #canvas:focus {
                outline: none;
            }

            #status,
            #status-splash,
            #status-progress {
                position: absolute;
                left: 0;
                right: 0;
            }

            #status,
            #status-splash {
                top: 0;
                bottom: 0;
            }

            #status {
                background-color: #fff9ef;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                visibility: hidden;
            }

            #status-splash {
                max-height: 100%;
                max-width: 100%;
                margin: auto;
            }

            #status-splash.show-image--false {
                display: none;
            }

            #status-splash.fullsize--true {
                height: 100%;
                width: 100%;
                object-fit: contain;
            }

            #status-splash.use-filter--false {
                image-rendering: pixelated;
            }

            #status-spinner,
            #status-progress,
            #status-message,
            #status-hint,
            #status-notice {
                display: none;
            }

            #status-spinner {
                width: 48px;
                height: 48px;
                border: 5px solid #d9c8aa;
                border-top-color: #6a4e28;
                border-radius: 50%;
                animation: status-spin 0.9s linear infinite;
                margin-bottom: 1rem;
            }

            @keyframes status-spin {
                from {
                    transform: rotate(0deg);
                }
                to {
                    transform: rotate(360deg);
                }
            }

            #status-progress {
                bottom: 10%;
                width: 50%;
                margin: 0 auto;
            }

            #status-message {
                bottom: 5%;
                color: #263238;
                font-family: 'Noto Sans', 'Droid Sans', Arial, sans-serif;
                font-size: 0.95rem;
                text-align: center;
            }

            #status-hint {
                bottom: 2.5%;
                color: #5b4a33;
                font-family: 'Noto Sans', 'Droid Sans', Arial, sans-serif;
                font-size: 0.85rem;
                text-align: center;
            }

            #status-notice {
                background-color: #5b3943;
                border-radius: 0.5rem;
                border: 1px solid #9b3943;
                color: #e0e0e0;
                font-family: 'Noto Sans', 'Droid Sans', Arial, sans-serif;
                line-height: 1.3;
                margin: 0 2rem;
                overflow: hidden;
                padding: 1rem;
                text-align: center;
                z-index: 1;
            }
        </style>
        <link id="-gd-engine-icon" rel="icon" type="image/png"
              href="index.icon.png" />
        <link rel="apple-touch-icon" href="index.apple-touch-icon.png" />

    </head>

    <body>
        <canvas id="canvas">
            Your browser does not support the canvas tag.
        </canvas>

        <noscript>
            Your browser does not support JavaScript.
        </noscript>

        <div id="status">
            <img id="status-splash"
                 class="show-image--true fullsize--true use-filter--true"
                 src="index.png" alt="">
            <div id="status-spinner"></div>
            <progress id="status-progress"></progress>
            <div id="status-message"></div>
            <div id="status-hint">Large download on first load. Keep this tab open.</div>
            <div id="status-notice"></div>
        </div>

        <script src="index.js"></script>
        <script>
            // Buffer error lines to avoid stack trace spam per line
            const errorBuffer = { lines: [], timeout: null };
            function flushErrors() {
                if (errorBuffer.lines.length > 0) {
                    console.error(errorBuffer.lines.join('\n'));
                    errorBuffer.lines = [];
                }
                errorBuffer.timeout = null;
            }
            function bufferedPrintError(text) {
                errorBuffer.lines.push(text);
                if (errorBuffer.timeout) clearTimeout(errorBuffer.timeout);
                errorBuffer.timeout = setTimeout(flushErrors, 10);
            }

            const GODOT_CONFIG = { "args": [], "canvasResizePolicy": 2, "emscriptenPoolSize": 8, "ensureCrossOriginIsolationHeaders": false, "executable": "index", "experimentalVK": false, "fileSizes": { "index.pck": 92499888, "index.wasm": 1588912 }, "focusCanvas": true, "gdextensionLibs": [], "godotPoolSize": 4, "onPrintError": bufferedPrintError };
            const GODOT_THREADS_ENABLED = false;
            const engine = new Engine(GODOT_CONFIG);

            (function () {
                const statusOverlay = document.getElementById('status');
                const statusSpinner = document.getElementById('status-spinner');
                const statusProgress = document.getElementById('status-progress');
                const statusMessage = document.getElementById('status-message');
                const statusHint = document.getElementById('status-hint');
                const statusNotice = document.getElementById('status-notice');
                const pckBytes = (GODOT_CONFIG.fileSizes && GODOT_CONFIG.fileSizes['index.pck']) || 0;
                const STALL_TIMEOUT_MS = 12000;

                let initializing = true;
                let statusMode = '';
                let lastProgressAt = Date.now();
                let fallbackShown = false;

                function formatMiB(bytes) {
                    return (bytes / (1024 * 1024)).toFixed(1);
                }

                function setStatusMessage(text) {
                    statusMessage.textContent = text;
                }

                function setStatusMode(mode) {
                    if (statusMode === mode || !initializing) {
                        return;
                    }
                    if (mode === 'hidden') {
                        statusOverlay.remove();
                        initializing = false;
                        return;
                    }
                    statusOverlay.style.visibility = 'visible';
                    statusSpinner.style.display = mode === 'progress' ? 'block' : 'none';
                    statusProgress.style.display = mode === 'progress' ? 'block' : 'none';
                    statusMessage.style.display = mode === 'progress' ? 'block' : 'none';
                    statusHint.style.display = mode === 'progress' ? 'block' : 'none';
                    statusNotice.style.display = mode === 'notice' ? 'block' : 'none';
                    statusMode = mode;
                }

                function setStatusNotice(text) {
                    while (statusNotice.lastChild) {
                        statusNotice.removeChild(statusNotice.lastChild);
                    }
                    const lines = text.split('\n');
                    lines.forEach((line) => {
                        statusNotice.appendChild(document.createTextNode(line));
                        statusNotice.appendChild(document.createElement('br'));
                    });
                }

                function displayFailureNotice(err) {
                    console.error(err);
                    if (err instanceof Error) {
                        setStatusNotice(err.message);
                    } else if (typeof err === 'string') {
                        setStatusNotice(err);
                    } else {
                        setStatusNotice('An unknown error occurred.');
                    }
                    setStatusMode('notice');
                    initializing = false;
                }

                function maybeShowFallbackNotice() {
                    if (statusMode !== 'progress' || fallbackShown) {
                        return;
                    }
                    if ((Date.now() - lastProgressAt) < STALL_TIMEOUT_MS) {
                        return;
                    }
                    fallbackShown = true;
                    const currentText = statusMessage.textContent || 'Loading...';
                    setStatusMessage(`${currentText} This is taking longer than expected. Network may be slow; please keep this page open.`);
                }

                const missing = Engine.getMissingFeatures({
                    threads: GODOT_THREADS_ENABLED,
                });

                if (missing.length !== 0) {
                    if (GODOT_CONFIG['serviceWorker'] && GODOT_CONFIG['ensureCrossOriginIsolationHeaders'] && 'serviceWorker' in navigator) {
                        let serviceWorkerRegistrationPromise;
                        try {
                            serviceWorkerRegistrationPromise = navigator.serviceWorker.getRegistration();
                        } catch (err) {
                            serviceWorkerRegistrationPromise = Promise.reject(new Error('Service worker registration failed.'));
                        }
                        // There's a chance that installing the service worker would fix the issue
                        Promise.race([
                            serviceWorkerRegistrationPromise.then((registration) => {
                                if (registration != null) {
                                    return Promise.reject(new Error('Service worker already exists.'));
                                }
                                return registration;
                            }).then(() => engine.installServiceWorker()),
                            // For some reason, `getRegistration()` can stall
                            new Promise((resolve) => {
                                setTimeout(() => resolve(), 2000);
                            }),
                        ]).then(() => {
                            // Reload if there was no error.
                            window.location.reload();
                        }).catch((err) => {
                            console.error('Error while registering service worker:', err);
                        });
                    } else {
                        // Display the message as usual
                        const missingMsg = 'Error\nThe following features required to run Godot projects on the Web are missing:\n';
                        displayFailureNotice(missingMsg + missing.join('\n'));
                    }
                } else {
                    setStatusMode('progress');
                    setInterval(maybeShowFallbackNotice, 1000);
                    if (pckBytes > 0) {
                        setStatusMessage(`Downloading game data (${formatMiB(pckBytes)} MiB)...`);
                    } else {
                        setStatusMessage('Downloading game data...');
                    }
                    engine.startGame({
                        'onProgress': function (current, total) {
                            lastProgressAt = Date.now();
                            fallbackShown = false;
                            if (current > 0 && total > 0) {
                                statusProgress.value = current;
                                statusProgress.max = total;
                                const percent = Math.floor((current / total) * 100);
                                setStatusMessage(`Loading... ${percent}% (${formatMiB(current)} / ${formatMiB(total)} MiB)`);
                            } else {
                                statusProgress.removeAttribute('value');
                                statusProgress.removeAttribute('max');
                                setStatusMessage('Loading...');
                            }
                        },
                    }).then(() => {
                        setStatusMode('hidden');
                    }, displayFailureNotice);
                }
            }());
        </script>
    </body>

</html>

